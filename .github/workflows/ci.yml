name: CI

on:
    pull_request:
    push:
        branches:
            - main
    schedule:
        - cron: "37 6 * * 1-5"

env:
    RUST_BACKTRACE: 1
    CARGO_TERM_COLOR: always

jobs:
    test:
        name: Build & Test ${{ matrix.target }}
        strategy:
            fail-fast: false
            matrix:
                include:
                    - target: x86_64-unknown-linux-gnu
                      os: ubuntu-latest
                    - target: aarch64-apple-darwin
                      os: macos-latest
                      just_goals: build
                    - target: x86_64-apple-darwin
                      os: macos-latest
                    - target: x86_64-pc-windows-msvc
                      os: windows-latest
        runs-on: ${{ matrix.os }}
        env:
            CARGO_BUILD_TARGET: ${{ matrix.target }}
        steps:
            - uses: actions/checkout@08c6903cd8c0fde910a37f88322edcfb5dd907a8 # v5
              with:
                  submodules: recursive

            - uses: dtolnay/rust-toolchain@nightly
              with:
                  targets: ${{ matrix.target }}

            - uses: Swatinem/rust-cache@98c8021b550208e191a6a3145459bfc9fb29c4c0 # v2

            - uses: extractions/setup-just@e33e0265a09d6d736e2ee1e0eb685ef1de4669ff # v3
              env:
                  GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

            - run: just ${{ matrix.just_goals || 'build test' }}

    lint:
        runs-on: ubuntu-latest
        steps:
            - uses: actions/checkout@08c6903cd8c0fde910a37f88322edcfb5dd907a8 # v5
              with:
                  submodules: recursive

            - uses: dtolnay/rust-toolchain@nightly
              with:
                  components: rustfmt, clippy

            - uses: Swatinem/rust-cache@98c8021b550208e191a6a3145459bfc9fb29c4c0 # v2

            - uses: extractions/setup-just@e33e0265a09d6d736e2ee1e0eb685ef1de4669ff # v3
              env:
                  GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

            - run: just lint

    should-publish:
        name: Check if version changed
        runs-on: ubuntu-latest
        outputs:
            is_new_version: ${{ steps.check.outputs.is_new_version }}
            publish_tag: ${{ steps.check.outputs.publish_tag }}
        steps:
            - uses: actions/checkout@08c6903cd8c0fde910a37f88322edcfb5dd907a8 # v5
              with:
                  submodules: recursive

            - uses: dtolnay/rust-toolchain@nightly

            - uses: Swatinem/rust-cache@98c8021b550208e191a6a3145459bfc9fb29c4c0 # v2

            - run: cargo install cargo-info

            - id: check
              run: |
                  CURRENT_VERSION="$(./scripts/get_current_version.sh tiktoken-rs)"
                  echo "Current version: $CURRENT_VERSION"

                  EXISTING_VERSIONS="$(cargo info -VV tiktoken-rs 2>/dev/null | awk '/^ *VERSION[[:space:]]+RELEASED[[:space:]]+DOWNLOADS/ {in_tbl=1; next} in_tbl && /^[[:space:]]*$/ {in_tbl=0} in_tbl {print $1}')"

                  if echo "$EXISTING_VERSIONS" | grep -xq "$CURRENT_VERSION"; then
                    echo "Version $CURRENT_VERSION already published"
                    echo "is_new_version=no" >> $GITHUB_OUTPUT
                  else
                    echo "Version $CURRENT_VERSION is new"
                    echo "is_new_version=yes" >> $GITHUB_OUTPUT
                    echo "publish_tag=v$CURRENT_VERSION" >> $GITHUB_OUTPUT
                  fi

    release:
        name: Release
        needs: [test, lint, should-publish]
        if: needs.should-publish.outputs.is_new_version == 'yes' && github.ref == 'refs/heads/main'
        uses: ./.github/workflows/release.yml
        with:
            publish-tag: ${{ needs.should-publish.outputs.publish_tag }}
        secrets:
            CARGO_REGISTRY_TOKEN: ${{ secrets.CARGO_REGISTRY_TOKEN }}
